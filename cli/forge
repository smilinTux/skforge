#!/usr/bin/env bash
# forge ‚Äî The Forgeprint CLI
# AI-native software blueprints. Don't use software. Forge your own.
# https://forgeprint.dev | S&K Holdings | Apache 2.0
#
# Making Self-Hosting & Decentralized Systems Cool Again üêß

set -euo pipefail

VERSION="0.1.0"
FORGE_HOME="${FORGE_HOME:-$HOME/.forgeprint}"
BLUEPRINTS_DIR="$FORGE_HOME/blueprints"
REPO_URL="https://github.com/smilinTux/forgeprint.git"
RAW_URL="https://raw.githubusercontent.com/smilinTux/forgeprint/main"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

penguin() {
  cat << 'EOF'

    üêß Forgeprint
    Don't use software. Forge your own.

EOF
}

usage() {
  penguin
  cat << EOF
${BOLD}USAGE${NC}
  forge <command> [options]

${BOLD}COMMANDS${NC}
  ${GREEN}init${NC}          Interactive setup ‚Äî pick a blueprint, choose features, select language
  ${GREEN}build${NC}         Generate code from driver.md + blueprint specs (requires AI)
  ${GREEN}test${NC}          Validate generated code against blueprint test specs
  ${GREEN}list${NC}          Browse available blueprint categories
  ${GREEN}search${NC}        Search blueprints and features
  ${GREEN}info${NC}          Show details for a specific blueprint
  ${GREEN}update${NC}        Pull latest blueprints from the registry
  ${GREEN}new${NC}           Create a new blueprint from template (for contributors)
  ${GREEN}doctor${NC}        Check your setup (AI provider, blueprints, dependencies)
  ${GREEN}version${NC}       Show version

${BOLD}QUICK START${NC}
  forge init                    # Interactive wizard
  forge init load-balancers     # Skip to a specific category
  forge build                   # Generate code from ./driver.md
  forge build -o ./my-project   # Generate to specific directory

${BOLD}EXAMPLES${NC}
  ${DIM}# Create a custom load balancer in Rust${NC}
  forge init load-balancers --lang rust
  ${DIM}# ... edit driver.md to select your features ...${NC}
  forge build

  ${DIM}# Quick build with all defaults${NC}
  echo "category: web-servers" > driver.md
  echo "target: go" >> driver.md
  forge build

${BOLD}ENVIRONMENT${NC}
  FORGE_HOME        Blueprint storage (default: ~/.forgeprint)
  FORGE_AI          AI provider: openai|anthropic|ollama|moonshot (default: auto-detect)
  FORGE_MODEL       Model to use (default: provider's best)
  FORGE_API_KEY     API key for cloud AI providers

${BOLD}LINKS${NC}
  Website:    https://forgeprint.dev
  GitHub:     https://github.com/smilinTux/forgeprint
  Discord:    https://discord.gg/smilintux
  Blueprints: https://forgeprint.dev/blueprints

${DIM}Making Self-Hosting & Decentralized Systems Cool Again üêß${NC}
${DIM}S&K Holdings ‚Äî Helping architect our quantum future, one smile at a time.${NC}
EOF
}

# ‚îÄ‚îÄ‚îÄ Ensure blueprints are installed ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
ensure_blueprints() {
  if [[ ! -d "$BLUEPRINTS_DIR" ]]; then
    echo -e "${YELLOW}Blueprints not found. Downloading...${NC}"
    cmd_update
  fi
}

# ‚îÄ‚îÄ‚îÄ COMMANDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

cmd_version() {
  echo "forge v${VERSION}"
}

cmd_update() {
  echo -e "${CYAN}üêß Updating blueprints...${NC}"
  mkdir -p "$FORGE_HOME"
  
  if [[ -d "$BLUEPRINTS_DIR/.git" ]]; then
    cd "$BLUEPRINTS_DIR"
    git pull --quiet
    echo -e "${GREEN}‚úÖ Blueprints updated.${NC}"
  else
    echo -e "  Cloning blueprint repository..."
    git clone --quiet --depth 1 "$REPO_URL" "$BLUEPRINTS_DIR" 2>/dev/null || {
      echo -e "${RED}Failed to clone. Check your internet connection.${NC}"
      exit 1
    }
    echo -e "${GREEN}‚úÖ Blueprints installed at $BLUEPRINTS_DIR${NC}"
  fi
  
  # Count blueprints
  local count
  count=$(find "$BLUEPRINTS_DIR/blueprints" -maxdepth 1 -type d 2>/dev/null | wc -l)
  count=$((count - 1))  # subtract the blueprints/ dir itself
  echo -e "  ${DIM}${count} blueprint categories available${NC}"
}

cmd_list() {
  ensure_blueprints
  
  echo -e "${BOLD}üì¶ Available Blueprints${NC}\n"
  
  local bp_dir="$BLUEPRINTS_DIR/blueprints"
  
  if [[ ! -d "$bp_dir" ]]; then
    echo -e "${YELLOW}No blueprints found. Run: forge update${NC}"
    return 1
  fi
  
  for dir in "$bp_dir"/*/; do
    [[ ! -d "$dir" ]] && continue
    local name
    name=$(basename "$dir")
    [[ "$name" == "TEMPLATE" ]] && continue
    
    local features="?"
    if [[ -f "$dir/features.yml" ]]; then
      features=$(grep -c "^\s*- name:" "$dir/features.yml" 2>/dev/null || echo "?")
    fi
    
    local desc=""
    if [[ -f "$dir/BLUEPRINT.md" ]]; then
      desc=$(head -5 "$dir/BLUEPRINT.md" | grep -v "^#" | grep -v "^$" | head -1)
    fi
    
    printf "  ${GREEN}%-25s${NC} ${DIM}%s features${NC}  %s\n" "$name" "$features" "$desc"
  done
  
  echo -e "\n${DIM}Run 'forge info <category>' for details${NC}"
  echo -e "${DIM}Run 'forge init <category>' to start building${NC}"
}

cmd_info() {
  ensure_blueprints
  local category="${1:-}"
  
  if [[ -z "$category" ]]; then
    echo -e "${RED}Usage: forge info <category>${NC}"
    echo -e "${DIM}Run 'forge list' to see available categories${NC}"
    return 1
  fi
  
  local bp_dir="$BLUEPRINTS_DIR/blueprints/$category"
  
  if [[ ! -d "$bp_dir" ]]; then
    echo -e "${RED}Blueprint '$category' not found.${NC}"
    echo -e "${DIM}Run 'forge list' to see available categories${NC}"
    return 1
  fi
  
  echo -e "${BOLD}üîß Blueprint: $category${NC}\n"
  
  # Show BLUEPRINT.md summary
  if [[ -f "$bp_dir/BLUEPRINT.md" ]]; then
    head -30 "$bp_dir/BLUEPRINT.md"
    echo -e "\n${DIM}... (run 'cat $bp_dir/BLUEPRINT.md' for full spec)${NC}"
  fi
  
  # Show feature count
  if [[ -f "$bp_dir/features.yml" ]]; then
    local features
    features=$(grep -c "^\s*- name:" "$bp_dir/features.yml" 2>/dev/null || echo "0")
    echo -e "\n${CYAN}Features: $features available${NC}"
  fi
  
  # Show available files
  echo -e "\n${BOLD}Files:${NC}"
  find "$bp_dir" -type f | sort | while read -r f; do
    local rel="${f#$bp_dir/}"
    printf "  üìÑ %s\n" "$rel"
  done
}

cmd_init() {
  local category="${1:-}"
  local lang="${2:-}"
  local output_dir="."
  
  penguin
  echo -e "${BOLD}üî® Forge Init ‚Äî Let's build something.${NC}\n"
  
  ensure_blueprints
  
  # Pick category
  if [[ -z "$category" ]]; then
    echo -e "${BOLD}Step 1: Pick your blueprint${NC}\n"
    
    local categories=()
    local i=1
    for dir in "$BLUEPRINTS_DIR/blueprints"/*/; do
      [[ ! -d "$dir" ]] && continue
      local name
      name=$(basename "$dir")
      [[ "$name" == "TEMPLATE" ]] && continue
      categories+=("$name")
      
      local features="?"
      if [[ -f "$dir/features.yml" ]]; then
        features=$(grep -c "^\s*- name:" "$dir/features.yml" 2>/dev/null || echo "?")
      fi
      printf "  ${GREEN}%2d)${NC} %-25s ${DIM}(%s features)${NC}\n" "$i" "$name" "$features"
      i=$((i + 1))
    done
    
    echo ""
    read -rp "  Choose (number or name): " choice
    
    if [[ "$choice" =~ ^[0-9]+$ ]] && [[ "$choice" -ge 1 ]] && [[ "$choice" -le "${#categories[@]}" ]]; then
      category="${categories[$((choice - 1))]}"
    else
      category="$choice"
    fi
  fi
  
  echo -e "\n  ${GREEN}‚úì${NC} Blueprint: ${BOLD}$category${NC}"
  
  # Pick language
  if [[ -z "$lang" ]]; then
    echo -e "\n${BOLD}Step 2: Choose your language${NC}\n"
    local languages=("rust" "go" "python" "java" "typescript" "dotnet" "zig" "c" "cpp")
    local j=1
    for l in "${languages[@]}"; do
      printf "  ${GREEN}%d)${NC} %s\n" "$j" "$l"
      j=$((j + 1))
    done
    echo ""
    read -rp "  Choose (number or name): " lchoice
    
    if [[ "$lchoice" =~ ^[0-9]+$ ]] && [[ "$lchoice" -ge 1 ]] && [[ "$lchoice" -le "${#languages[@]}" ]]; then
      lang="${languages[$((lchoice - 1))]}"
    else
      lang="$lchoice"
    fi
  fi
  
  echo -e "  ${GREEN}‚úì${NC} Language: ${BOLD}$lang${NC}"
  
  # Generate driver.md
  local bp_dir="$BLUEPRINTS_DIR/blueprints/$category"
  local driver_file="$output_dir/driver.md"
  
  echo -e "\n${BOLD}Step 3: Generating driver.md${NC}\n"
  
  {
    echo "# driver.md ‚Äî My Custom ${category//-/ }"
    echo ""
    echo "## Blueprint"
    echo "category: $category"
    echo ""
    echo "## Language"
    echo "target: $lang"
    echo ""
    echo "## Profile"
    echo "hardware: server"
    echo "memory: standard"
    echo ""
    echo "## Features"
    echo "<!-- Select features below. [x] = include, [ ] = skip -->"
    echo ""
    
    # Parse features.yml if it exists
    if [[ -f "$bp_dir/features.yml" ]]; then
      local current_group=""
      while IFS= read -r line; do
        # Detect group names
        if [[ "$line" =~ ^[[:space:]]*-\ name:\ (.+) ]]; then
          local item="${BASH_REMATCH[1]}"
          # Check if this is a group or feature by context
          if [[ "$line" =~ ^[[:space:]]{2}-\ name: ]]; then
            echo "### $item"
          elif [[ "$line" =~ ^[[:space:]]{6,}-\ name: ]]; then
            # Read default value
            echo "- [x] $item"
          fi
        fi
      done < "$bp_dir/features.yml"
    else
      echo "<!-- No features.yml found for this blueprint -->"
      echo "<!-- Add features manually based on BLUEPRINT.md -->"
    fi
    
    echo ""
    echo "## Build"
    echo "auto-test: true"
    echo "auto-benchmark: false"
    echo "output: ./${category}-custom/"
  } > "$driver_file"
  
  echo -e "  ${GREEN}‚úì${NC} Created: ${BOLD}$driver_file${NC}"
  echo -e ""
  echo -e "${BOLD}Next steps:${NC}"
  echo -e "  1. Edit ${CYAN}driver.md${NC} ‚Äî check/uncheck features you want"
  echo -e "  2. Run  ${CYAN}forge build${NC} ‚Äî AI generates your custom software"
  echo -e "  3. Run  ${CYAN}forge test${NC}  ‚Äî validate against blueprint specs"
  echo -e ""
  echo -e "${DIM}Tip: Review the full blueprint at:${NC}"
  echo -e "${DIM}  $bp_dir/BLUEPRINT.md${NC}"
  echo -e ""
  echo -e "${GREEN}Happy forging! üêß${NC}"
}

cmd_build() {
  local driver="${1:-driver.md}"
  
  if [[ ! -f "$driver" ]]; then
    echo -e "${RED}No driver.md found in current directory.${NC}"
    echo -e "${DIM}Run 'forge init' to create one, or specify path: forge build path/to/driver.md${NC}"
    return 1
  fi
  
  ensure_blueprints
  
  # Parse driver.md
  local category lang output
  category=$(grep "^category:" "$driver" | awk '{print $2}' | tr -d '[:space:]')
  lang=$(grep "^target:" "$driver" | awk '{print $2}' | tr -d '[:space:]')
  output=$(grep "^output:" "$driver" | awk '{print $2}' | tr -d '[:space:]')
  output="${output:-./$category-custom/}"
  
  if [[ -z "$category" ]]; then
    echo -e "${RED}No 'category:' found in driver.md${NC}"
    return 1
  fi
  
  local bp_dir="$BLUEPRINTS_DIR/blueprints/$category"
  if [[ ! -d "$bp_dir" ]]; then
    echo -e "${RED}Blueprint '$category' not found. Run 'forge update' or 'forge list'.${NC}"
    return 1
  fi
  
  penguin
  echo -e "${BOLD}üî® Forging: $category ‚Üí $lang${NC}"
  echo -e "${DIM}Output: $output${NC}\n"
  
  # Detect AI provider
  local ai_provider="${FORGE_AI:-}"
  local api_key="${FORGE_API_KEY:-}"
  local model="${FORGE_MODEL:-}"
  
  if [[ -z "$ai_provider" ]]; then
    # Auto-detect
    if command -v ollama &>/dev/null; then
      ai_provider="ollama"
      model="${model:-qwen2.5:32b}"
      echo -e "  ${GREEN}‚úì${NC} AI: Ollama (local) ‚Äî ${DIM}$model${NC}"
    elif [[ -n "${ANTHROPIC_API_KEY:-}" ]]; then
      ai_provider="anthropic"
      api_key="$ANTHROPIC_API_KEY"
      model="${model:-claude-sonnet-4-20250514}"
      echo -e "  ${GREEN}‚úì${NC} AI: Anthropic ‚Äî ${DIM}$model${NC}"
    elif [[ -n "${OPENAI_API_KEY:-}" ]]; then
      ai_provider="openai"
      api_key="$OPENAI_API_KEY"
      model="${model:-gpt-4o}"
      echo -e "  ${GREEN}‚úì${NC} AI: OpenAI ‚Äî ${DIM}$model${NC}"
    elif [[ -n "${MOONSHOT_API_KEY:-}" ]]; then
      ai_provider="moonshot"
      api_key="$MOONSHOT_API_KEY"
      model="${model:-kimi-k2-0905-preview}"
      echo -e "  ${GREEN}‚úì${NC} AI: Moonshot ‚Äî ${DIM}$model${NC}"
    else
      echo -e "${RED}No AI provider detected.${NC}"
      echo -e "${DIM}Set one of: FORGE_AI, ANTHROPIC_API_KEY, OPENAI_API_KEY, MOONSHOT_API_KEY${NC}"
      echo -e "${DIM}Or install Ollama for local inference: https://ollama.ai${NC}"
      return 1
    fi
  fi
  
  # Collect blueprint context
  echo -e "\n  üìã Loading blueprint specs..."
  
  local context_file
  context_file=$(mktemp)
  
  {
    echo "=== DRIVER CONFIGURATION ==="
    cat "$driver"
    echo ""
    echo "=== BLUEPRINT SPECIFICATION ==="
    [[ -f "$bp_dir/BLUEPRINT.md" ]] && cat "$bp_dir/BLUEPRINT.md"
    echo ""
    echo "=== FEATURES CATALOG ==="
    [[ -f "$bp_dir/features.yml" ]] && cat "$bp_dir/features.yml"
    echo ""
    echo "=== ARCHITECTURE GUIDE ==="
    [[ -f "$bp_dir/architecture.md" ]] && cat "$bp_dir/architecture.md"
    echo ""
    echo "=== MEMORY MANAGEMENT ==="
    local mem_profile
    mem_profile=$(grep "^memory:" "$driver" | awk '{print $2}' | tr -d '[:space:]')
    mem_profile="${mem_profile:-standard}"
    [[ -f "$bp_dir/memory-profiles/$mem_profile.md" ]] && cat "$bp_dir/memory-profiles/$mem_profile.md"
    echo ""
    echo "=== TEST SPECIFICATIONS ==="
    for test_file in "$bp_dir/tests/"*.md; do
      [[ -f "$test_file" ]] && cat "$test_file" && echo ""
    done
  } > "$context_file"
  
  local context_size
  context_size=$(wc -c < "$context_file")
  echo -e "  ${GREEN}‚úì${NC} Loaded ${DIM}$(( context_size / 1024 ))KB${NC} of blueprint context"
  
  # Build the AI prompt
  local prompt="You are Forgeprint, an AI software forge. Read the following blueprint specification and driver configuration, then generate a COMPLETE, WORKING implementation in ${lang}.

REQUIREMENTS:
1. Implement ONLY the features marked [x] in the driver configuration
2. Follow the architecture patterns from the blueprint
3. Follow the memory management guide for the selected profile
4. Generate ALL unit tests specified in the test specifications
5. Include proper error handling, logging, and configuration
6. Generate a complete project structure with build files
7. Code must compile/run without modifications
8. Include a README.md with build and run instructions

OUTPUT FORMAT:
For each file, output:
--- FILE: path/to/file ---
<file contents>
--- END FILE ---

Generate all files needed for a complete, buildable project."

  echo -e "  üî® Forging... (this may take a few minutes)\n"
  
  # Call AI based on provider
  case "$ai_provider" in
    ollama)
      local combined
      combined=$(cat "$context_file")
      curl -s "http://localhost:11434/api/generate" \
        -d "{\"model\":\"$model\",\"prompt\":\"$prompt\n\n$combined\",\"stream\":false}" \
        | python3 -c "import sys,json; print(json.load(sys.stdin).get('response',''))" \
        > "${context_file}.output" 2>/dev/null
      ;;
    anthropic)
      local combined
      combined=$(cat "$context_file")
      curl -s "https://api.anthropic.com/v1/messages" \
        -H "x-api-key: $api_key" \
        -H "anthropic-version: 2023-06-01" \
        -H "content-type: application/json" \
        -d "{\"model\":\"$model\",\"max_tokens\":8192,\"messages\":[{\"role\":\"user\",\"content\":\"$prompt\n\n$combined\"}]}" \
        | python3 -c "import sys,json; r=json.load(sys.stdin); print(r['content'][0]['text'] if 'content' in r else r.get('error',{}).get('message','Unknown error'))" \
        > "${context_file}.output" 2>/dev/null
      ;;
    openai|moonshot)
      local base_url="https://api.openai.com/v1"
      [[ "$ai_provider" == "moonshot" ]] && base_url="https://api.moonshot.ai/v1"
      local combined
      combined=$(cat "$context_file")
      curl -s "$base_url/chat/completions" \
        -H "Authorization: Bearer $api_key" \
        -H "Content-Type: application/json" \
        -d "{\"model\":\"$model\",\"max_tokens\":8192,\"messages\":[{\"role\":\"user\",\"content\":\"$prompt\n\n$combined\"}]}" \
        | python3 -c "import sys,json; r=json.load(sys.stdin); print(r['choices'][0]['message']['content'] if 'choices' in r else r.get('error',{}).get('message','Unknown error'))" \
        > "${context_file}.output" 2>/dev/null
      ;;
  esac
  
  # Parse output into files
  if [[ -f "${context_file}.output" ]] && [[ -s "${context_file}.output" ]]; then
    mkdir -p "$output"
    
    local current_file=""
    local file_count=0
    
    while IFS= read -r line; do
      if [[ "$line" =~ ^---\ FILE:\ (.+)\ ---$ ]]; then
        current_file="${BASH_REMATCH[1]}"
        mkdir -p "$output/$(dirname "$current_file")"
        > "$output/$current_file"  # create/truncate
      elif [[ "$line" =~ ^---\ END\ FILE\ ---$ ]]; then
        if [[ -n "$current_file" ]]; then
          echo -e "  ${GREEN}‚úì${NC} ${current_file}"
          file_count=$((file_count + 1))
          current_file=""
        fi
      elif [[ -n "$current_file" ]]; then
        echo "$line" >> "$output/$current_file"
      fi
    done < "${context_file}.output"
    
    echo -e "\n${GREEN}‚úÖ Forged $file_count files ‚Üí $output${NC}"
    echo -e "${DIM}Next: cd $output && forge test${NC}"
  else
    echo -e "${RED}AI returned empty response. Check your API key and model.${NC}"
    return 1
  fi
  
  # Cleanup
  rm -f "$context_file" "${context_file}.output"
}

cmd_test() {
  echo -e "${YELLOW}üß™ Test runner coming soon.${NC}"
  echo -e "${DIM}For now, run your language's test suite manually.${NC}"
  echo -e "${DIM}Blueprint test specs are at: blueprints/<category>/tests/${NC}"
}

cmd_search() {
  ensure_blueprints
  local query="${1:-}"
  
  if [[ -z "$query" ]]; then
    echo -e "${RED}Usage: forge search <query>${NC}"
    return 1
  fi
  
  echo -e "${BOLD}üîç Searching blueprints for: $query${NC}\n"
  grep -ril "$query" "$BLUEPRINTS_DIR/blueprints/" 2>/dev/null | while read -r f; do
    local rel="${f#$BLUEPRINTS_DIR/}"
    local match
    match=$(grep -i "$query" "$f" | head -1 | sed 's/^[[:space:]]*//')
    printf "  ${GREEN}%s${NC}\n    ${DIM}%s${NC}\n" "$rel" "$match"
  done
}

cmd_new() {
  local name="${1:-}"
  
  if [[ -z "$name" ]]; then
    echo -e "${RED}Usage: forge new <category-name>${NC}"
    echo -e "${DIM}Creates a new blueprint from the template${NC}"
    return 1
  fi
  
  ensure_blueprints
  
  local template_dir="$BLUEPRINTS_DIR/blueprints/TEMPLATE"
  local new_dir="./blueprints/$name"
  
  if [[ -d "$new_dir" ]]; then
    echo -e "${RED}Blueprint '$name' already exists.${NC}"
    return 1
  fi
  
  cp -r "$template_dir" "$new_dir"
  echo -e "${GREEN}‚úÖ Created blueprint template at $new_dir${NC}"
  echo -e "${DIM}Edit the files, then submit a PR to smilinTux/forgeprint${NC}"
}

cmd_doctor() {
  penguin
  echo -e "${BOLD}ü©∫ Forge Doctor${NC}\n"
  
  # Check blueprints
  if [[ -d "$BLUEPRINTS_DIR" ]]; then
    local count
    count=$(find "$BLUEPRINTS_DIR/blueprints" -maxdepth 1 -type d 2>/dev/null | wc -l)
    count=$((count - 1))
    echo -e "  ${GREEN}‚úì${NC} Blueprints installed ($count categories)"
  else
    echo -e "  ${RED}‚úó${NC} Blueprints not installed (run: forge update)"
  fi
  
  # Check AI providers
  echo -e "\n  ${BOLD}AI Providers:${NC}"
  
  if command -v ollama &>/dev/null; then
    local models
    models=$(ollama list 2>/dev/null | wc -l)
    echo -e "  ${GREEN}‚úì${NC} Ollama installed ($models models)"
  else
    echo -e "  ${DIM}‚óã${NC} Ollama not installed (https://ollama.ai)"
  fi
  
  [[ -n "${ANTHROPIC_API_KEY:-}" ]] && echo -e "  ${GREEN}‚úì${NC} Anthropic API key set" || echo -e "  ${DIM}‚óã${NC} ANTHROPIC_API_KEY not set"
  [[ -n "${OPENAI_API_KEY:-}" ]] && echo -e "  ${GREEN}‚úì${NC} OpenAI API key set" || echo -e "  ${DIM}‚óã${NC} OPENAI_API_KEY not set"
  [[ -n "${MOONSHOT_API_KEY:-}" ]] && echo -e "  ${GREEN}‚úì${NC} Moonshot API key set" || echo -e "  ${DIM}‚óã${NC} MOONSHOT_API_KEY not set"
  
  # Check tools
  echo -e "\n  ${BOLD}Tools:${NC}"
  command -v git &>/dev/null && echo -e "  ${GREEN}‚úì${NC} git" || echo -e "  ${RED}‚úó${NC} git (required)"
  command -v curl &>/dev/null && echo -e "  ${GREEN}‚úì${NC} curl" || echo -e "  ${RED}‚úó${NC} curl (required)"
  command -v python3 &>/dev/null && echo -e "  ${GREEN}‚úì${NC} python3" || echo -e "  ${RED}‚úó${NC} python3 (required)"
  
  echo -e "\n${DIM}All good? Run 'forge init' to start building!${NC}"
}

# ‚îÄ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

case "${1:-}" in
  init)     shift; cmd_init "$@" ;;
  build)    shift; cmd_build "$@" ;;
  test)     shift; cmd_test "$@" ;;
  list)     shift; cmd_list "$@" ;;
  search)   shift; cmd_search "$@" ;;
  info)     shift; cmd_info "$@" ;;
  update)   shift; cmd_update "$@" ;;
  new)      shift; cmd_new "$@" ;;
  doctor)   shift; cmd_doctor "$@" ;;
  version|-v|--version) cmd_version ;;
  help|-h|--help|"") usage ;;
  *)
    echo -e "${RED}Unknown command: $1${NC}"
    echo -e "${DIM}Run 'forge help' for usage${NC}"
    exit 1
    ;;
esac
